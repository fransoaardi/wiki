# intro

- when building big-size docker image, ran into error message like `no space left on device`.
- modification of the previous misleading information
- in short, previous wiki was wrong, but still don't know how to increase the limitation on the docker image to deal with `no space left on device` other than **decreasing the size of the docker image**.
- maybe it is not needed to do so

> Most containers have a default 10GB rootfs size when the container is built, so you'll have to use the --storage-opt to 
resize that. I've encountered containers that have a >10GB rootfs by default, so it can also be set on build if you're 
building those containers. overlay2 won't resize the rootfs of the container automatically, it just uses the underlying fs of the host so you don't have to configure the storage driver specifically in that case like you do with the devicemapper driver. One option is to just build a xfs partition on your laptop and move storage to that so overlay2 will handle resizing.

> https://www.reddit.com/r/docker/comments/71mift/how_to_increase_docker_container_storage_limit/dnlmyu6/

# misleading points

- when googling for the situation, this reference is easily found
  - https://docs.docker.com/engine/reference/commandline/dockerd/

- but the document above is related to when storage driver is `devicemapper`, but current system (Amazon Linux 2) was 
based on `overlay2`

- as it can be seen with the console below, it shows `overlay2` storage driver with `xfs` file system
```
$ docker info

(...)
Storage Driver: overlay2
 Backing Filesystem: xfs
 Supports d_type: true
 Native Overlay Diff: true
Logging Driver: json-file
Cgroup Driver: cgroupfs
SType: linux
Architecture: x86_64
```

- therefore, `dm.basesize` option should not work

- there is an option like `--storage-opt overlay2.size=1G`
but it works based on `xfs mounted with the pquota mount option`,
never tested.

```
$ docker run -it --storage-opt size=10G alpine:latest /bin/bash
docker: Error response from daemon: --storage-opt is supported only for overlay over xfs with 'pquota' mount option.
See 'docker run --help'.
```
> console showing failed, on osx. 

```
Set storage driver options per container
$ docker run -it --storage-opt size=120G fedora /bin/bash
This (size) will allow to set the container rootfs size to 120G at creation time. This option is only available for the devicemapper, btrfs, overlay2, windowsfilter and zfs graph drivers. For the devicemapper, btrfs, windowsfilter and zfs graph drivers, user cannot pass a size less than the Default BaseFS Size. For the overlay2 storage driver, the size option is only available if the backing fs is xfs and mounted with the pquota mount option. Under these conditions, user can pass any size less than the backing fs size.
```
> reference: https://docs.docker.com/engine/reference/commandline/run/#set-storage-driver-options-per-container


# references
- docker reference on overlay file system
  - https://docs.docker.com/storage/storagedriver/overlayfs-driver/
- good material
  - https://www.joinc.co.kr/w/man/12/docker/storage
- material on setting size driver-option on each container, but doesn't work
  - https://docs.docker.com/engine/reference/commandline/run/#set-storage-driver-options-per-container

---
# CAUTION: FROM HERE BELOW, THE MATERIAL CAN MISLEAD. JUST LEFT FOR THE HISTORY

## ~history~

when building docker image, ran into error message like below
```
no space left on device
```

## ~why~
- when building docker image, docker image may be larger than the default 10G 

- `nothing is set on docker-storage file.`
```
$ cat /etc/sysconfig/docker-storage
# This file may be automatically generated by an installation program.

# By default, Docker uses a loopback-mounted sparse file in
# /var/lib/docker.  The loopback makes it slower, and there are some
# restrictive defaults, such as 100GB max storage.

# If your installation did not set a custom storage for Docker, you
# may do it below.

# Example: Use a custom pair of raw logical volumes (one for metadata,
# one for data).
# DOCKER_STORAGE_OPTIONS="--storage-opt dm.metadatadev=/dev/myvg/my-docker-metadata --storage-opt dm.datadev=/dev/myvg/my-docker-data"

DOCKER_STORAGE_OPTIONS=
```
## ~howto~

```console
# stop docker
sudo systemctl stop docker

# remove /var/lib/docker because prior filesystem may crash with additional setting
sudo rm -rf /var/lib/docker

# change basesize from 10G to 50G
sudo dockerd --storage-opt dm.basesize=50G

# re-run docker
sudo systemctl start docker
```

## ~references~
- https://docs.docker.com/engine/reference/commandline/dockerd/

```
dm.basesize
Specifies the size to use when creating the base device, which limits the size of images and containers. The default value is 10G. Note, thin devices are inherently “sparse”, so a 10G device which is mostly empty doesn’t use 10 GB of space on the pool. However, the filesystem will use more space for the empty case the larger the device is.

The base device size can be increased at daemon restart which will allow all future images and containers (based on those new images) to be of the new base device size.

Examples
$ sudo dockerd --storage-opt dm.basesize=50G
This will increase the base device size to 50G. The Docker daemon will throw an error if existing base device size is larger than 50G. A user can use this option to expand the base device size however shrinking is not permitted.

This value affects the system-wide “base” empty filesystem that may already be initialized and inherited by pulled images. Typically, a change to this value requires additional steps to take effect:

$ sudo service docker stop

$ sudo rm -rf /var/lib/docker

$ sudo service docker start
```
