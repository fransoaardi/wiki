# intro 
docker network 관련해서 모르고 이용했던것이 많았고, 우연한 기회에 문서를 찾아 읽었다. 
docker network 는 `docker0` 인터페이스가 `osx` 에는 없고 여러 유틸(`iptable`, `brctl` 등.. )등을 고려하여, `linux` 를 기준으로 작성한다.

# information in detail

- docker 가 설치된 linux host 에서 `ifconfig` 명령어를 입력시 `docker0` network interface 가 생성되어있다. 
> `ifconfig`
```
(자세한 내용 생략)
docker0: 
eth0: 
```

- `docker network ls` 해보면 `bridge(이하 default-bridge)`, `host`, `none` network 가 이미 만들어져있다. 
> `docker network ls`
```
NETWORK ID          NAME                DRIVER              SCOPE
3c8be4b70b6d        bridge              bridge              local
5e62d92497d8        host                host                local
571e2458615e        none                null                local
```

- docker container 생성시 `--network` 값을 지정하지 않으면 `default-bridge` 로 자동지정된다, 2개의 컨테이너를 사용중이었는데 이미 `default-bridge` 에 종속되어있다. 

> `docker network inspect bridge -f "{{json .Containers}}"`
```
{
    "4dcebe0b0b6c08fee3a05b6e4c21cd7aa5d251e9c8984acbdf3e8f7ef5b54a13": {
        "Name": "container-1",
        "EndpointID": "...",
        "MacAddress": "...",
        "IPv4Address": "172.17.0.2/16",
        "IPv6Address": ""
    },
    "f2f4793ca08aa27ad2695ecbe9f3f507d27b97f5513da2a987601106d37c3122": {
        "Name": "container-2",
        "EndpointID": "...",
        "MacAddress": "...",
        "IPv4Address": "172.17.0.3/16",
        "IPv6Address": ""
    }
}
```

- `default-bridge` vs `user-defined-bridge`

`user-defined-bridge` 를 구성하려면 아래와같이 `docker network create` 하고 사용하면 된다. 

> `docker network create user-bridge`
> `docker network ls`
```
NETWORK ID          NAME                DRIVER              SCOPE
3c8be4b70b6d        bridge              bridge              local
5e62d92497d8        host                host                local
571e2458615e        none                null                local
4f1876f97493        user-bridge         bridge              local
```

- `user-defined-bridge` 와 `default-bridge` 사이의 성능차이는 이해하기 힘들다.
- 오히려 `host` vs `bridge` 는 명확해보인다.

`ifconfig` 해보면 방금 생성한 `bridge` 가 host 의 새로운 network interface 로 생성되어있다.

새로 생성한 `user-bridge` 에 새로운 container alpine1 을 설정해보고 `brctl(bridge control)` 을 통해서 확인해보았다. 

> `ifconfig`
```
br-4f1876f97493: 
docker0:
```

> `docker run -dit --name alpine1 --network user-bridge alpine ash`
> `brctl show docker0`
```
bridge name	bridge id		STP enabled	interfaces
docker0		8000.02421a0751ea	no		veth75bcd24
vethb437c84
```

> `brctl show br-4f1876f97493`
```
bridge name	bridge id		STP enabled	interfaces
br-4f1876f97493		8000.0242f74574ba	no		veth47ad8dd
```

`default-bridge` vs `user-defined-bridge` hop 을 예상해보면 아래처럼 비슷한 양상을 띨거라 생각된다.  
그에 반해 `host` network 의 hop 은 단순하다 
```
default-bridge:
  host eth0 -> host docker0 -> veth -> container eth0
user-defined-bridge:
  host eth0 -> host user-bridge -> veth -> container eth0
host:
  host eth0 -> container eth0
```

`default-bridge` 일때는 `/etc/resolv.conf` 파일이 아래와 같다.
> `docker exec -t default-container cat /etc/resolv.conf`
```
; generated by /usr/sbin/dhclient-script
search ap-northeast-2.compute.internal
options timeout:2 attempts:5
nameserver 172.31.0.2
```

`user-defined-bridge` 일때는 `/etc/resolv.conf` 파일이 아래와 같다. 
> `docker exec -t alpine1 cat /etc/resolv.conf`
```
search ap-northeast-2.compute.internal
nameserver 127.0.0.11
options timeout:2 attempts:5 ndots:0
```

**네임서버** 가 다른걸 알 수 있다. 
`default-bridge` 인 경우는, 같은 network 내에 ip 주소로 ping 이 가능하지만, hostname (container name, `/etc/hostname` 파일에 명시된 값, `docker run` 할때 `--hostname` 지정해서 넘길 수 있다. 지정하지 않은 경우 container ID 값으로 지정된다) 으로는 `ping` 실패한다. 

`user-defined-bridge` 인 경우는 network 내에 ip 주소 + hostname 으로도 ping 가능하다. (구체적인 실험은 아래의 reference tutorial 참고)

- 이부분은 `/etc/hosts` on the fly 연동 등의 장점이 있다.
- 구체적인 예시로는 `docker-compose` 했을때, 예를들어 backend 라는 container 를 scale out 했을때, `http://backend` 으로 loadbalancing 되는것을 확인할 수 있다.


# references
- docker official docs network overview
  - https://docs.docker.com/network/

- docker official docs using user-defined + default bridge network tutorial
  - https://docs.docker.com/network/network-tutorial-standalone/

- docker network 관련
  - https://bluese05.tistory.com/15 
  - https://jeongchul.tistory.com/636
